<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://localhost:8000/jsonFiles/list.js"></script>
<div id="phoneWrapper" style="display: none;">
    <h1>Student Phone Numbers</h1>
    <table>
        <thead>
            <tr>
                <th>Name Last, First</th>
                <th>Phone Number</th>
            </tr>
        </thead>
        <tbody id="studentInfo">
        </tbody>
    </table>
</div>

<script>
    var locker = (function() {
        function readFile(fileName, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/d2l/api/le/1.14/locker/myLocker/' + fileName);
            xhr.setRequestHeader("X-Csrf-Token", localStorage['XSRF.Token']);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    callback(xhr);
                }
            };
            xhr.send();
        }
        return {
            'readFile': readFile,
        };
    }());

    //generates the html table in the widget
    function generateTable(course) {
        var row;
        course.students.forEach(function(student) {
            row = "<tr><td>" + student.name + "</td><td>" + student.phone + "</td></tr>";
            $(row).appendTo('tbody#studentInfo');
        });
    }

    //reads the course's json file from the locker
    function readLocker() {
        locker.readFile("filteredByCourse.json", function(results) {
            if (results.status != 200) {
                console.log('unable to find student information');
                return;
            }
            var instructor = JSON.parse(results.response);
            getCurrentCourse(instructor);
        });
    }

    // determines what course the widget is in
    function getCurrentCourse(instructor) {
        $('div#phoneWrapper').css({
            display: 'block'
        });
        var xhr = new XMLHttpRequest();
        //var currentCourseTitle = window.top.document.querySelector('div.d2l-navigation-s-header-logo-area>a.d2l-navigation-s-link').innerText,
        function findMatch() {
            if (xhr.readyState == 4) {
                var currentCourseTitle = JSON.parse(xhr.response).Name.toString(),
                    currentCourse;
                instructor.courses.forEach(function(course) {
                    if (course.courseName === currentCourseTitle)
                        currentCourse = course;
                });
                //console.log(currentCourse);
                generateTable(currentCourse)
            }
        }
        var ou = window.location.href.match(/\/home\/(\d+)/)[1],
            url = '/d2l/api/lp/1.14/courses/' + ou;
        xhr.open('GET', url);
        xhr.onreadystatechange = findMatch;
        xhr.send();
    }

    $(document).ready(getCurrentCourse);
    //$(document).ready(readLocker);

</script>
